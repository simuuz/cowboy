name: Build

on: push

jobs:
  build-win64:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@master
      
      - uses: msys2/setup-msys2@v2
        with:
          install: make mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-sfml
      
      - name: Install dependencies
        run: |
          cd ../include/external/imgui-sfml/
          cmake -DIMGUI_DIR=../imgui/
          cmake --build . --target install
          cd ../../
      
      - name: Build natsukashii
        run: |
          mkdir build
          cmake \
            -G "Unix Makefiles" \
            -DCMAKE_EXE_LINKER_FLAGS="-static-libgcc -static-libstdc++" \
            -B build
          make -j -C build
          
      - name: Collect files
        run: |
          mkdir upload
          mv build/natsukashii.exe upload
          rm -rf build
        
      - name: Upload files
        uses: actions/upload-artifact@master
        with:
          name: natsukashii-win64
          path: upload

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@master
      
      - name: Install dependencies
        run: |
          sudo apt-get update -y -qq
          sudo apt-get install libsfml-dev
          cd include/external/imgui-sfml/
          cmake -DIMGUI_DIR=../imgui/
          cmake --build . --target install
          cd ../../
      
      - name: Build natsukashii
        run: | 
          mkdir build
          cmake -B build
          make -j -C build
          
      - name: Collect files
        run: |
          mkdir upload
          mv build/natsukashii upload
          rm -rf build
        
      - name: Upload files
        uses: actions/upload-artifact@master
        with:
          name: natsukashii-linux
          path: upload
 